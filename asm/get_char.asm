GLOBAL get_char

-- [_, _] -> [char, _]
get_char:
  KEY_A A_B 
  RAM_AL 0xF0 SUB JMPRZ $release 
  RAM_AL 0xE0 SUB JMPRZ $extended
  RAM_AL 0x12 SUB JMPRZ $shift 
  RAM_A scancode_to_ascii SUM A_B rB_AL
  -- RAM_B last_char A_rB
  RET

release:
  KEY_A
  JMPR $get_char

extended:
  PUSHB INCSP
  KEY_A A_B
  RAM_AL 0xF0 SUB JMPRZ $release
  RAM_AL 0x5A SUB JMPRZ $newline
  B_A
  DECSP POPB B_AH
  -- RAM_B last_char A_rB
  RET

shift:
  RAM_A 0xF00F
  HLT

newline:
  RAM_AL 0x0A
  -- RAM_B last_char A_rB
  RET

scancode_to_ascii:
  0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
  0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F
  0x10 0x11 0x12 0x13 0x14  "q"  "1" 0x17
  0x18 0x19  "z"  "s"  "a"  "w"  "2" 0x1F
  0x20  "c"  "x"  "d"  "e"  "4"  "3" 0x27
  0x28  " "  "v"  "f"  "t"  "r"  "4" 0x2F
  0x30  "n"  "b"  "h"  "g"  "y"  "5" 0x37
  0x38 0x39  "m"  "j"  "u"  "6"  "7" 0x3F
  0x40 0x41  "k"  "i"  "o"  "0"  "8" 0x47
  0x48 0x49 0x4A  "l" 0x4C  "p" 0x4E 0x4F
  0x50 0x51 0x52 0x53 0x54 0x55 0x56 0x57
  0x58 0x59 0x5A 0x5B 0x5C 0x5D 0x5E 0x5F
  0x60 0x61 0x62 0x63 0x64 0x65 0x66 0x67
  0x68 0x69 0x6A 0x6B 0x6C 0x6D 0x6E 0x6F
  0x70 0x71 0x72 0x73 0x74 0x75 0x76 0x77
  0x78  "9" 0x7A  "-" 0x7C 0x7D 0x7E 0x7F
